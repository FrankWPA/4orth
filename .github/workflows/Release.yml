name: Release

on:
  push:
    tags:        
      - '*'


jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out from Git
        uses: actions/checkout@v3
      - uses: dawidd6/action-download-artifact@v2
        with:
          workflow: CI.yml
          workflow_conclusion: success
          name: 4orth

      - name: Get Latest Release
        id: latest_version
        uses: abatilo/release-info-action@v1.3.0
        with:
          owner: FrankWPA
          repo:  4orth

      - name: Get Current Tag
        id: get_version
        uses: olegtarasov/get-tag@v2.1

      - name: Build release if tag is new
        if: ${{ steps.get_version.outputs.tag != steps.latest_version.outputs.latest_tag }}
        env:
          TAG: ${{ steps.get_version.outputs.tag }}
        run: |
          mkdir "4oth-${TAG}-linux"
          mkdir "4oth-${TAG}-linux"/std
          mv 4orth "4oth-${TAG}-linux"/
          mv core.porth "4oth-${TAG}-linux"/std
          mv wasm4.porth "4oth-${TAG}-linux"/std
          mv LICENSE "4oth-${TAG}-linux"/std
          cd "4oth-${TAG}-linux"
          zip -r ../"4oth-${TAG}-linux".zip *
        
      - name: Publish release if tag is new  
        if: ${{ steps.get_version.outputs.tag != steps.latest_version.outputs.latest_tag }}
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "{{ GIT_TAG_NAME }}"
          prerelease: true
          files: 
            "4oth-$GIT_TAG_NAME-linux.zip"

